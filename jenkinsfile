pipeline {
  agent any

  environment {
    VENV = "${HOME}/.venvs/ansible"
    AWS_DEFAULT_REGION = 'us-east-1'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Prepare Environment') {
      steps {
        sh '''
          set -e
          mkdir -p "$(dirname "$VENV")"
          [ ! -d "$VENV" ] && python3 -m venv "$VENV"
          source "$VENV/bin/activate"
          pip install --upgrade pip setuptools wheel
          pip install ansible boto3 botocore
          ansible-galaxy collection install amazon.aws --force
        '''
      }
    }

    stage('Provision & Deploy') {
      steps {
        withAWS(region: AWS_DEFAULT_REGION) {
          withCredentials([
            file(credentialsId: 'argo-private-key-id', variable: 'KEY_FILE_PATH'),
            string(credentialsId: 'ansible-vault-pass-id', variable: 'ANSIBLE_VAULT_PASSWORD')
          ]) {
            sh '''
              set -e
              source "$VENV/bin/activate"
              ansible-playbook ansible/playbooks/create_ec2.yaml \
                -e "ansible_private_key_file=$KEY_FILE_PATH" \
                --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD")

              ansible-playbook ansible/playbooks/configure_ec2.yaml \
                --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD")

              ansible-playbook ansible/playbooks/deploy_app.yaml \
                --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD")
            '''
          }
        }
      }
    }
  }

  post {
    success { echo 'Pipeline completed successfully!' }
    failure { echo 'Pipeline failed. Check logs for errors.' }
  }
}
