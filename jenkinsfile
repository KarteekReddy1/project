pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'ap-south-1'
    ANSIBLE_VAULT_PASSWORD = credentials('ansible-vault-pass-id') // Jenkins credential id
    AWS_CREDENTIALS = credentials('aws_jenkins_credentials') // stored AWS creds in Jenkins
    VENV = "${HOME}/.venvs/ansible"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Prepare env') {
      steps {
        sh '''
          python3 -m venv ${VENV} || true
          source ${VENV}/bin/activate
          pip install --upgrade pip
          pip install ansible boto3 botocore
          ansible-galaxy collection install amazon.aws || true
        '''
      }
    }

    stage('Build') {
      steps {
        // If you have a build step, run it here; for static site skip
        echo 'Build stage (if required)'
      }
    }

    stage('Provision EC2') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_jenkins_credentials', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          sh '''
          source ${VENV}/bin/activate
          ansible-playbook ansible/playbooks/create_ec2.yml --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

    stage('Configure Server') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_jenkins_credentials', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          sh '''
          source ${VENV}/bin/activate
          ansible-playbook -i ansible/inventories/aws_ec2.yml ansible/playbooks/configure_ec2.yml --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

    stage('Deploy App') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_jenkins_credentials', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          sh '''
          source ${VENV}/bin/activate
          ansible-playbook -i ansible/inventories/aws_ec2.yml ansible/playbooks/deploy_app.yml --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

  } // stages

  post {
    success { echo 'Pipeline finished successfully' }
    failure { echo 'Pipeline failed' }
  }
}
