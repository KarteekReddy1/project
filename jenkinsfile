pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    ANSIBLE_VAULT_PASSWORD = credentials('ansible-vault-pass-id')
    VENV = "${HOME}/.venvs/ansible"
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Prepare env') {
      steps {
        sh '''
          python3 -m venv ${VENV} || true
          source ${VENV}/bin/activate
          pip install --upgrade pip
          pip install ansible boto3 botocore
          ansible-galaxy collection install amazon.aws || true
        '''
      }
    }

    stage('Provision EC2') {
      steps {
        withAWS(credentials: 'aws_jenkins_credentials', region: 'us-east-1') {
          sh '''
            source ${VENV}/bin/activate
            ansible-playbook ansible/playbooks/create_ec2.yaml \
              --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

    stage('Configure Server') {
      steps {
        withAWS(credentials: 'aws_jenkins_credentials', region: 'us-east-1') {
          sh '''
            source ${VENV}/bin/activate
            ansible-playbook -i ansible/inventories/aws_ec2.yaml \
              ansible/playbooks/configure_ec2.yaml \
              --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

    stage('Deploy App') {
      steps {
        withAWS(credentials: 'aws_jenkins_credentials', region: 'us-east-1') {
          sh '''
            source ${VENV}/bin/activate
            ansible-playbook -i ansible/inventories/aws_ec2.yaml \
              ansible/playbooks/deploy_app.yaml\
              --vault-password-file <(echo "${ANSIBLE_VAULT_PASSWORD}")
          '''
        }
      }
    }

  }

  post {
    success { echo 'Pipeline finished successfully' }
    failure { echo 'Pipeline failed' }
  }
}







